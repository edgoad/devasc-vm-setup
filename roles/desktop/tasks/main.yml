---
- name: Install VS Code extension(s) for devasc (as user)
  become: false
  become_user: "{{ existing_user }}"
  command: code --install-extension ms-python.python
  ignore_errors: yes

- name: Ensure VS Code settings directory exists
  file:
    path: "{{ user_home }}/.config/Code/User"
    state: directory
    mode: '0755'
    owner: "{{ existing_user }}"
    group: "{{ existing_user }}"

- name: Ensure VS Code settings.json exists with Copilot disabled
  copy:
    dest: "{{ user_home }}/.config/Code/User/settings.json"
    content: |
      {
        "github.copilot.agent.enabled": false,
        "github.copilot.chat.enabled": false,
        "github.copilot.inlineSuggest.enable": false,
        "workbench.experimental.enableCopilot": false,
        "extensions.autoUpdate": false,
        "extensions.ignoreRecommendations": true,
        "chat.disableAIFeatures": true
      }
    owner: "{{ existing_user }}"
    group: "{{ existing_user }}"
    mode: '0644'

# Install mate desktop environment and set it as default
- name: Install MATE Desktop Environment
  apt:
    name: ubuntu-mate-desktop
    state: present
    cache_valid_time: 3600
    update_cache: yes
  notify: Restart GDM

- name: Set MATE as default session
  lineinfile:
    path: /etc/gdm3/custom.conf
    regexp: '^#?DefaultSession='
    line: 'DefaultSession=mate.desktop'
    insertafter: '[daemon]'
  notify: Restart GDM

# Create desktop shortcuts
- name: Ensure Desktop folder exists
  file:
    path: "{{ desktop_path }}"
    state: directory
    owner: devasc
    group: devasc
    mode: '0755'

- name: Shortcut for Labs Folder
  copy:
    dest: "{{ desktop_path }}/labs.desktop"
    content: |
      [Desktop Entry]
      Name=Labs
      Icon=folder
      Type=Link
      URL="{{ user_home }}/labs"
      Icon=user-bookmarks
    mode: '0755'
    owner: devasc
    group: devasc

- name: Shortcut for Terminal
  copy:
    dest: "{{ desktop_path }}/terminal.desktop"
    content: |
      [Desktop Entry]
      Name=Terminal
      Exec=gnome-terminal
      Icon=utilities-terminal
      Type=Application
      Terminal=false
    mode: '0755'
    owner: devasc
    group: devasc

- name: Shortcut for VSCode
  copy:
    dest: "{{ desktop_path }}/vscode.desktop"
    content: |
      [Desktop Entry]
      Name=Visual Studio Code
      Exec=/snap/bin/code
      Icon=/snap/code/current/meta/gui/vscode.png
      Type=Application
      Terminal=false
    mode: '0755'
    owner: devasc
    group: devasc

- name: Shortcut for postman
  copy:
    dest: "{{ desktop_path }}/postman.desktop"
    content: |
      [Desktop Entry]
      Name=Postman
      Exec=/snap/bin/postman
      Icon=/snap/postman/current/usr/share/postman/icons/icon_128x128.png
      Type=Application
      Terminal=false
    mode: '0755'
    owner: devasc
    group: devasc

- name: draw.io Shortcut
  copy:
    dest: "{{ desktop_path }}/drawio.desktop"
    content: |
      [Desktop Entry]
      Name=draw.io
      Exec=/snap/bin/drawio
      Icon=/snap/drawio/current/meta/gui/icon.png
      Type=Application
      Terminal=false
    mode: '0755'
    owner: devasc
    group: devasc

- name: Shortcut for Chromium
  copy:
    dest: "{{ desktop_path }}/chromium_chromium.desktop"
    content: |
      [Desktop Entry]
      Name=Chromium
      Exec=/snap/bin/chromium
      Icon=/snap/chromium/current/chromium.png
      Type=Application
      Terminal=false
    mode: '0755'
    owner: devasc
    group: devasc


- name: Disable GNOME idle timeout for user
  become: false
  become_user: "{{ existing_user }}"
  shell: dbus-launch gsettings set org.gnome.desktop.session idle-delay 0
  args:
    warn: false
  ignore_errors: yes

- name: Disable GNOME power sleep on AC for user
  become: false
  become_user: "{{ existing_user }}"
  shell: dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type 'nothing'
  args:
    warn: false
  ignore_errors: yes

