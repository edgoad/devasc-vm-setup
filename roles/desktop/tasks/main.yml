---
- name: Install VS Code extension(s) for devasc (as user)
  become: false
  become_user: "{{ existing_user }}"
  command: code --install-extension ms-python.python
  ignore_errors: yes

- name: Ensure VS Code settings directory exists
  file:
    path: "{{ user_home }}/.config/Code/User"
    state: directory
    mode: '0755'
    owner: "{{ existing_user }}"
    group: "{{ existing_user }}"

- name: Ensure VS Code settings.json exists with Copilot disabled
  copy:
    dest: "{{ user_home }}/.config/Code/User/settings.json"
    content: |
      {
        "github.copilot.agent.enabled": false,
        "github.copilot.chat.enabled": false,
        "github.copilot.inlineSuggest.enable": false,
        "workbench.experimental.enableCopilot": false,
        "extensions.autoUpdate": false,
        "extensions.ignoreRecommendations": true,
        "chat.disableAIFeatures": true
      }
    owner: "{{ existing_user }}"
    group: "{{ existing_user }}"
    mode: '0644'

# Create desktop shortcuts
- name: Ensure Desktop folder exists
  file:
    path: "{{ desktop_path }}"
    state: directory
    owner: devasc
    group: devasc
    mode: '0755'


- name: Install .desktop files
  copy:
    dest: "{{ desktop_path }}/{{ item.name }}"
    content: "{{ item.content }}"
    owner: "{{ existing_user }}"
    group: "{{ existing_user }}"
    mode: "0755"
  loop: "{{ shortcuts }}"

- name: Make .desktop files executable (defensive)
  file:
    path: "{{ desktop_path }}/{{ item.name }}"
    mode: "u+x,g+x,o+x"
  loop: "{{ shortcuts }}"

# IMPORTANT: Mark as trusted within the user's GNOME session
- name: Mark shortcuts as trusted via gio
  become: true
  become_user: "{{ existing_user }}"
  environment:
    # If this runs while the user is logged in to GNOME, DISPLAY is usually set.
    # If not, you can set DISPLAY and bootstrap a session bus via dbus-launch.
    DISPLAY: ":0"
  shell: |
    dbus-launch gio set "{{ desktop_path }}/{{ item.name }}" "metadata::trusted" true
  loop: "{{ shortcuts }}"
  changed_when: true
  register: gio_trust

- name: Debug gio output (optional)
  debug:
    var: gio_trust


# - name: Shortcut for Labs Folder
#   copy:
#     dest: "{{ desktop_path }}/labs.desktop"
#     content: |
#       [Desktop Entry]
#       Name=Labs
#       Icon=folder
#       Type=Link
#       URL={{ user_home }}/labs
#       Icon=user-bookmarks
#     mode: '0755'
#     owner: devasc
#     group: devasc

# - name: Shortcut for Terminal
#   copy:
#     dest: "{{ desktop_path }}/terminal.desktop"
#     content: |
#       [Desktop Entry]
#       Name=Terminal
#       Exec=gnome-terminal
#       Icon=utilities-terminal
#       Type=Application
#       Terminal=false
#     mode: '0755'
#     owner: devasc
#     group: devasc

# - name: Shortcut for VSCode
#   copy:
#     dest: "{{ desktop_path }}/vscode.desktop"
#     content: |
#       [Desktop Entry]
#       Name=Visual Studio Code
#       Exec=/snap/bin/code
#       Icon=/snap/code/current/meta/gui/vscode.png
#       Type=Application
#       Terminal=false
#     mode: '0755'
#     owner: devasc
#     group: devasc

# - name: Shortcut for postman
#   copy:
#     dest: "{{ desktop_path }}/postman.desktop"
#     content: |
#       [Desktop Entry]
#       Name=Postman
#       Exec=/snap/bin/postman
#       Icon=/snap/postman/current/usr/share/postman/icons/icon_128x128.png
#       Type=Application
#       Terminal=false
#     mode: '0755'
#     owner: devasc
#     group: devasc

# - name: draw.io Shortcut
#   copy:
#     dest: "{{ desktop_path }}/drawio.desktop"
#     content: |
#       [Desktop Entry]
#       Name=draw.io
#       Exec=/snap/bin/drawio
#       Icon=/snap/drawio/current/meta/gui/icon.png
#       Type=Application
#       Terminal=false
#     mode: '0755'
#     owner: devasc
#     group: devasc

# - name: Shortcut for Chromium
#   copy:
#     dest: "{{ desktop_path }}/chromium_chromium.desktop"
#     content: |
#       [Desktop Entry]
#       Name=Chromium
#       Exec=/snap/bin/chromium
#       Icon=/snap/chromium/current/chromium.png
#       Type=Application
#       Terminal=false
#     mode: '0755'
#     owner: devasc
#     group: devasc


# Setup to prevent screen from going to sleep
- name: Disable GNOME idle timeout
  command: >
    sudo -u devasc dbus-launch gsettings set org.gnome.desktop.session idle-delay 0

- name: Disable GNOME power sleep on AC
  command: >
    sudo -u devasc dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type 'nothing'

- name: Disable GNOME power sleep on battery
  command: >
    sudo -u devasc dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-battery-type 'nothing'

- name: Update systemd logind.conf to ignore lid and idle
  blockinfile:
    path: /etc/systemd/logind.conf
    block: |
      [Login]
      HandleLidSwitch=ignore
      IdleAction=ignore
  notify: Restart systemd-logind

