---
- name: Install VS Code extension(s) for devasc (as user)
  become: false
  become_user: "{{ existing_user }}"
  command: code --install-extension ms-python.python
  ignore_errors: yes

- name: Ensure VS Code settings directory exists
  file:
    path: "{{ user_home }}/.config/Code/User"
    state: directory
    mode: '0755'
    owner: "{{ existing_user }}"
    group: "{{ existing_user }}"

- name: Ensure VS Code settings.json exists with Copilot disabled
  copy:
    dest: "{{ user_home }}/.config/Code/User/settings.json"
    content: |
      {
        "github.copilot.agent.enabled": false,
        "github.copilot.chat.enabled": false,
        "github.copilot.inlineSuggest.enable": false,
        "workbench.experimental.enableCopilot": false,
        "extensions.autoUpdate": false,
        "extensions.ignoreRecommendations": true,
        "chat.disableAIFeatures": true
      }
    owner: "{{ existing_user }}"
    group: "{{ existing_user }}"
    mode: '0644'

# Create desktop shortcuts
- name: Ensure Desktop folder exists
  file:
    path: "{{ desktop_path }}"
    state: directory
    owner: devasc
    group: devasc
    mode: '0755'

- name: Install .desktop files
  copy:
    dest: "{{ desktop_path }}/{{ item.name }}"
    content: "{{ item.content }}"
    owner: "{{ existing_user }}"
    group: "{{ existing_user }}"
    mode: "0755"
  loop: "{{ shortcuts }}"

- name: Make .desktop files executable (defensive)
  file:
    path: "{{ desktop_path }}/{{ item.name }}"
    mode: "u+x,g+x,o+x"
  loop: "{{ shortcuts }}"

# IMPORTANT: Mark as trusted within the user's GNOME session
- name: Mark shortcuts as trusted via gio
  become: true
  become_user: "{{ existing_user }}"
  environment:
    # If this runs while the user is logged in to GNOME, DISPLAY is usually set.
    # If not, you can set DISPLAY and bootstrap a session bus via dbus-launch.
    DISPLAY: ":0"
  shell: |
    dbus-launch gio set "{{ desktop_path }}/{{ item.name }}" "metadata::trusted" true
  loop: "{{ shortcuts }}"
  changed_when: true
  register: gio_trust

- name: Debug gio output (optional)
  debug:
    var: gio_trust


- name: Create symlink on desktop pointing to labs
  ansible.builtin.file:
    src: "{{ user_home }}/labs"
    dest: "{{ desktop_path }}/labs"
    state: link
    owner: "{{ existing_user }}"
    group: "{{ existing_user }}"

# Update favorite apps in GNOME
- name: Update favorite apps in GNOME
  command: gsettings set org.gnome.shell favorite-apps "['firefox_firefox.desktop', 'chromium_chromium.desktop', 'org.gnome.Nautilus.desktop', 'org.gnome.Terminal.desktop', 'code_code.desktop', 'drawio_drawio.desktop', 'CiscoPacketTracer-9.0.0.desktop']"
  become: false


# Setup to prevent screen from going to sleep
- name: Disable GNOME idle timeout
  command: >
    sudo -u devasc dbus-launch gsettings set org.gnome.desktop.session idle-delay 0

- name: Disable GNOME power sleep on AC
  command: >
    sudo -u devasc dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type 'nothing'

- name: Disable GNOME power sleep on battery
  command: >
    sudo -u devasc dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-battery-type 'nothing'

- name: Update systemd logind.conf to ignore lid and idle
  blockinfile:
    path: /etc/systemd/logind.conf
    block: |
      [Login]
      HandleLidSwitch=ignore
      IdleAction=ignore
  notify: Restart systemd-logind

